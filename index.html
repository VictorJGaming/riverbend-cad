<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riverbend CAD / PROQA ‚Äî Station 4 RBVFD</title>
<style>
  :root{--bg:#0d0e11;--card:#141621;--line:#202235;--ink:#e8f7ee;--muted:#9cc7b3;--hi:#00e18e;--warn:#ffb100;--danger:#ff5a54;--good:#36d399;--blue:#67baff}
  *{box-sizing:border-box} body{margin:0;background:#0b0c10;color:var(--ink);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Arial}
  header{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(#121424,#0d0e14)}
  header h1{font-size:16px;margin:0} header .sub{color:var(--muted);font-size:12px}
  .statusbar{margin-left:auto;display:flex;gap:8px;align-items:center}
  .pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0f1120;font-size:12px}
  .wrap{max-width:1250px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns: 1.3fr .9fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);background:#121424;font-size:13px;text-transform:uppercase;letter-spacing:.6px;color:#bfe9cb}
  .pad{padding:12px}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:12px}
  input,select,textarea,button{width:100%;padding:9px 10px;border:1px solid #29304a;background:#0f1220;color:var(--ink);border-radius:8px;font:inherit}
  textarea{min-height:110px;resize:vertical}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .btn{cursor:pointer;transition:.15s transform ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:#1b2a20;border-color:#2f7d55}
  .btn.warn{background:#2a2412;border-color:#7d6a2f}
  .btn.danger{background:#2a1412;border-color:#7d2f2f}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #2a2e47;border-radius:999px;background:#0f1220;cursor:pointer}
  .chip em{font-style:normal;color:#94b1a2}
  .chip[data-state="AVAILABLE"]{opacity:1}
  .chip[data-state="OOS"]{opacity:.45;filter:grayscale(1)}
  .chip[data-state="DISPATCHED"]{box-shadow:0 0 0 1px #6a5b1a inset}
  .chip[data-state="ENROUTE"]{box-shadow:0 0 0 1px #6a6f15 inset}
  .chip[data-state="ONSCENE"]{box-shadow:0 0 0 1px #186143 inset}
  .chip[data-state="TRANSPORT"]{box-shadow:0 0 0 1px #1a4f7a inset}
  .chip[data-state="RETURNING"]{box-shadow:0 0 0 1px #3d3d66 inset}
  .chip[data-state="CLEAR"]{opacity:.8}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:6px;font-size:11px}
  .A{color:#79f4a1}.B{color:#78cfff}.C{color:#ffe08a}.D{color:#ffb15a}.E{color:#ff8078}
  .log{white-space:pre-wrap;background:#0e1020;border:1px solid #232840;border-radius:10px;padding:10px;min-height:180px}
  .note{font-size:12px;color:#93a7bd}
  .sep{height:1px;background:linear-gradient(90deg,transparent,#232840,transparent);margin:10px 0}
  @media (max-width:1000px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div style="width:38px;height:38px;border:1px solid var(--line);border-radius:8px;background:linear-gradient(135deg,#1a1d2d,#10121c)"></div>
  <div>
    <h1>Riverbend CAD / PROQA ‚Äî <span class="A">Station 4 RBVFD</span></h1>
    <div class="sub">Fire-focused, station-based dispatch ‚Ä¢ Clawson codes ‚Ä¢ Roblox & Discord ready</div>
  </div>
  <div class="statusbar">
    <div class="pill" id="active">IDLE</div>
    <div class="pill" id="clock">--:--:--Z</div>
    <div class="pill">Dispatcher: <span id="dispName">Unknown</span></div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Call Creator -->
  <section class="card">
    <h3>Call Creator (PROQA ‚Äî all questions on one screen)</h3>
    <div class="pad">
      <div class="row">
        <div style="grid-column:span 3">
          <label>CAD #</label>
          <input id="cad" readonly />
        </div>
        <div style="grid-column:span 3">
          <label>Category</label>
          <select id="category">
            <option value="FIRE">üî• Fire</option>
            <option value="EMS">üöë EMS</option>
            <option value="RESCUE">üöí Rescue / MVA</option>
            <option value="SERVICE">‚öôÔ∏è Service / Investigation</option>
          </select>
        </div>
        <div style="grid-column:span 3">
          <label>Incident Subtype</label>
          <select id="subtype"></select>
        </div>
        <div style="grid-column:span 3">
          <label>Priority (Clawson)</label>
          <select id="prio">
            <option value="A">A ‚Äî Alpha</option>
            <option value="B">B ‚Äî Bravo</option>
            <option value="C">C ‚Äî Charlie</option>
            <option value="D">D ‚Äî Delta</option>
            <option value="E">E ‚Äî Echo</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="grid-column:span 6">
          <label>Location</label>
          <input id="location" placeholder="215 Maple St" />
        </div>
        <div style="grid-column:span 3">
          <label>Cross</label>
          <input id="cross" placeholder="@ Oak Ave" />
        </div>
        <div style="grid-column:span 3">
          <label>City</label>
          <input id="city" value="Riverbend County" />
        </div>
      </div>

      <div class="row">
        <div style="grid-column:span 4">
          <label>Caller</label>
          <input id="caller" placeholder="Name" />
        </div>
        <div style="grid-column:span 4">
          <label>Callback #</label>
          <input id="phone" placeholder="(555) 555-0155" />
        </div>
        <div style="grid-column:span 4">
          <label>Assign Station</label>
          <select id="station">
            <option value="4" selected>Station 4 RBVFD</option>
            <option value="3" disabled>Station 3 RBVFD (coming soon)</option>
          </select>
        </div>
      </div>

      <!-- PROQA QUESTIONS (populate based on category/subtype) -->
      <div class="sep"></div>
      <div id="questions" class="grid2"></div>

      <div class="sep"></div>
      <label>Narrative</label>
      <textarea id="narrative" placeholder="Auto-seeded from answers. You can edit."></textarea>

      <div class="sep"></div>
      <div class="row">
        <div style="grid-column:span 6">
          <label>Computed Determinant</label>
          <input id="determinant" readonly placeholder="NN-X-YY (auto)" />
        </div>
        <div style="grid-column:span 6;display:flex;gap:8px;align-items:end;justify-content:flex-end">
          <button class="btn" id="seed">Seed Answers</button>
          <button class="btn primary" id="compute">Compute Code</button>
          <button class="btn warn" id="dispatch">Dispatch</button>
          <button class="btn danger" id="clear">Clear</button>
        </div>
      </div>
      <div class="note">Rules: Fire/Rescue/MVA ‚Üí tone **Station** only (apparatus chosen by RBVFD). EMS E ‚Üí add Station Assist. Overdose/Unconscious ‚â• C ‚Üí **Narcan Assist** (Station Assist). MVA flags (HV/Entrap/Pin-in/Rollover) ‚Üí **Veh Acc w/ Rescue** + **RSU**.</div>
    </div>
  </section>

  <!-- RIGHT: Log + Units -->
  <section class="card">
    <h3>Active Call Log</h3>
    <div class="pad">
      <div class="log" id="log"></div>
      <div class="sep"></div>
      <div class="grid2">
        <div>
          <label>Bridge URL (Cloudflare Worker)</label>
          <input id="bridgeUrl" placeholder="https://riverbend-bridge.YOURNAME.workers.dev" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="toDiscord">Send / Update Discord</button>
            <button class="btn" id="toRoblox">Send / Update Roblox</button>
          </div>
        </div>
        <div>
          <label>Discord Webhook (set in Worker)</label>
          <input readonly value="(Configured in Worker, not here)" />
          <div class="note">We relay via the Worker (safer, avoids CORS & hides token).</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Units ‚Äî Station & EMS (toggle OOS, click to advance status)</h3>
    <div class="pad">
      <div class="chips" id="unitPool"></div>
      <div class="sep"></div>
      <button class="btn" id="oosFilter">Show OOS Only</button>
      <button class="btn" id="allFilter">Show All</button>
    </div>
  </section>
</div>

<script>
/* ============ Minimal config (extend anytime) ============ */
const STATION_LABELS = { "4":"Station 4 RBVFD", "3":"Station 3 RBVFD" };
const EMS_UNITS = [
  {id:'M101', name:'Medic 101 (ALS)'},
  {id:'M102', name:'Medic 102 (BLS)'},
  {id:'M103', name:'Medic 103 (BLS)'},
  {id:'M1',   name:'Medic 1 (Supervisor)'},
  {id:'RSU',  name:'Rescue Support Unit'}
];
const STA4_UNITS = [
  {id:'E4-1', name:'Engine 4-1'},
  {id:'SQ4-2',name:'Squad 4-2'},
  {id:'T4-3', name:'Tanker 4-3'},
  {id:'T4',  name:'Tower 4'},
  {id:'B4',  name:'Brush 4'},
  {id:'QRV4',name:'QRV 4'},
  {id:'CAR4',name:'Car 4'}
];
const UNIT_LIST = [...EMS_UNITS, ...STA4_UNITS]; // add Station 3 later

// Subtypes per category
const SUBTYPES = {
  FIRE: ['Structure Fire','Vehicle Fire','Brush / Wildland','Alarm ‚Äì Fire','Gas Leak / HazMat'],
  EMS: ['Breathing Problems','Chest Pain','Cardiac Arrest','Overdose / Poisoning','Unconscious / Fainting','Seizure','Trauma','Stroke','Sick Person'],
  RESCUE: ['MVC ‚Äî Injury','MVC ‚Äî High Velocity','MVC ‚Äî Entrapment','MVC ‚Äî Pin-in','MVC ‚Äî Rollover','Technical Rescue'],
  SERVICE: ['Public Assist','Investigation','Utility Problem','Standby']
};

// Question banks (show on one screen). Keep 8‚Äì12; examples shown.
const QUESTIONS = {
  'Overdose / Poisoning': [
    'Is the patient conscious?',
    'Is the patient breathing normally?',
    'Suspected opioid?',
    'Naloxone available / given?',
    'Approximate age?',
    'Scene safe?',
    'Number of patients?',
    'Caller with patient?'
  ],
  'Unconscious / Fainting': [
    'Is the patient responsive?',
    'Is the patient breathing normally?',
    'Is there major trauma?',
    'Skin signs (pale/diaphoretic)?',
    'Age?',
    'History of similar?',
    'Hazards on scene?',
    'Caller with patient?'
  ],
  'Cardiac Arrest': [
    'Breathing normally?',
    'Conscious?',
    'CPR started?',
    'AED available?',
    'Age?',
    'Trauma involved?',
    'Hazards?',
    'Caller with patient?'
  ],
  'MVC ‚Äî Injury': [
    'Vehicles involved?',
    'Estimated speed (mph)?',
    'Airbags deployed?',
    'Entrapment?',
    'Rollover?',
    'Pin-in?',
    'Scene safe?',
    'Patients count?'
  ],
  'Structure Fire': [
    'Smoke or flames visible?',
    'Occupants inside / unknown?',
    'Building type (SFD/Apt/Comm)?',
    'Power/gas hazards?',
    'Exposure risk?',
    'Time of day?',
    'Caller location (inside/outside)?',
    'Other hazards?'
  ]
};

// Determinant map (simple examples; extend as needed)
const PROTOCOLS = {
  'Breathing Problems': {proto: '06', rules: (ans)=> ans['Is the patient breathing normally?']==='No' ? 'E-01' : 'C-02'},
  'Cardiac Arrest':     {proto: '09', rules: (ans)=> 'E-02'},
  'Overdose / Poisoning':{proto:'23', rules: (ans)=>{
      if(ans['Is the patient conscious?']==='No') return 'D-01';
      if(ans['Is the patient breathing normally?']==='No') return 'E-01';
      return 'C-01';
  }},
  'Unconscious / Fainting':{proto:'31', rules:(ans)=>{
      if(ans['Is the patient responsive?']==='No' && ans['Is the patient breathing normally?']==='No') return 'E-01';
      if(ans['Is the patient responsive?']==='No') return 'D-01';
      return 'C-01';
  }},
  'MVC ‚Äî Injury':       {proto: '32', rules:(ans)=>{
      if(['Yes','yes'].includes(ans['Entrapment?']) || ['Yes','yes'].includes(ans['Pin-in?']) || ['Yes','yes'].includes(ans['Rollover?'])) return 'D-01'; // Veh Acc w/ Rescue
      const sp = parseInt(ans['Estimated speed (mph)?']||'0',10);
      if(sp>=45) return 'D-01';
      return 'C-01';
  }},
  'MVC ‚Äî High Velocity':{proto: '32', rules:(_)=> 'D-01'},
  'MVC ‚Äî Entrapment':   {proto: '32', rules:(_)=> 'D-01'},
  'MVC ‚Äî Pin-in':       {proto: '32', rules:(_)=> 'D-01'},
  'MVC ‚Äî Rollover':     {proto: '32', rules:(_)=> 'D-01'},
  'Structure Fire':     {proto: '67', rules:(ans)=> (ans['Smoke or flames visible?']==='Flames') ? 'D-02' : 'C-01'},
  'Vehicle Fire':       {proto: '68', rules:(_)=> 'C-01'},
  'Brush / Wildland':   {proto: '69', rules:(_)=> 'C-02'},
  'Alarm ‚Äì Fire':       {proto: '67', rules:(_)=> 'B-01'},
  'Gas Leak / HazMat':  {proto: '70', rules:(_)=> 'D-01'},
  'Seizure':            {proto: '12', rules:(_)=> 'C-01'},
  'Chest Pain':         {proto: '10', rules:(_)=> 'C-01'},
  'Sick Person':        {proto: '26', rules:(_)=> 'A-01'},
  'Trauma':             {proto: '30', rules:(_)=> 'C-02'},
  'Stroke':             {proto: '28', rules:(_)=> 'C-01'},
  'Public Assist':      {proto: '53', rules:(_)=> 'A-01'},
  'Investigation':      {proto: '52', rules:(_)=> 'A-01'},
  'Utility Problem':    {proto: '54', rules:(_)=> 'B-01'},
  'Standby':            {proto: '56', rules:(_)=> 'A-01'}
};

/* ============ State ============ */
const STATUS_FLOW = ['AVAILABLE','DISPATCHED','ENROUTE','ONSCENE','TRANSPORT','RETURNING','CLEAR','OOS'];
let UNITS = {}; // id -> {name,state}
let ANSWERS = {}; // question -> answer
let CURRENT = null; // current call object
let OOS_FILTER = false;

/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
const nowZ = () => new Date().toISOString().replace('T',' ').replace(/\.\d+Z$/,'Z');
const pad = n => String(n).padStart(4,'0');
const nextCAD = ()=>{ let n=+localStorage.getItem('rbCadSeq')||0; n++; localStorage.setItem('rbCadSeq',n); return `RB-INC-${pad(n)}`; };
const peekCAD = ()=> `RB-INC-${pad(+localStorage.getItem('rbCadSeq')||0)}`;
function log(t){ const L=$('#log'); L.textContent += (L.textContent?'\n':'') + `[${nowZ()}] ${t}`; $('#active').textContent='ACTIVE'; }

/* ============ UI Build ============ */
function buildSubtype(){
  const cat=$('#category').value;
  const list = SUBTYPES[cat] || [];
  $('#subtype').innerHTML = list.map(v=>`<option>${v}</option>`).join('');
  buildQuestions();
}
function buildQuestions(){
  const type = $('#subtype').value;
  const qs = QUESTIONS[type] || [];
  const host = $('#questions'); host.innerHTML='';
  // 8‚Äì12 on one screen; if fewer defined, we render what exists.
  for(const q of qs){
    const wrap=document.createElement('div');
    wrap.innerHTML = `<label>${q}</label><input data-q="${q}" />`;
    host.appendChild(wrap);
  }
}
function readAnswers(){
  ANSWERS={};
  document.querySelectorAll('#questions [data-q]').forEach(inp=>{ ANSWERS[inp.dataset.q]=inp.value.trim(); });
}
function computeDeterminant(){
  readAnswers();
  const st = $('#subtype').value;
  const base = PROTOCOLS[st];
  let code = '??-?-??';
  if(base){
    const tail = base.rules(ANSWERS);      // e.g., 'D-01'
    const letter = tail.split('-')[0];     // D
    code = `${base.proto}-${letter}-${tail.split('-')[1]}`;
    // Also set visible priority to the letter part so UI matches code
    $('#prio').value = letter;
  }
  $('#determinant').value = code;
  // Seed narrative quickly
  if(!$('#narrative').value){
    $('#narrative').value = `${st} coded ${code}. Caller: ${$('#caller').value||'Unknown'}. Key notes: ${Object.entries(ANSWERS).map(([k,v])=>`${k}=${v||'n/a'}`).join('; ')}`;
  }
  // Special logic hooks
  const pr = $('#prio').value;
  const cat = $('#category').value;
  specialRules(cat, st, pr);
}
function specialRules(cat, subtype, prio){
  // Narcan Assist: Overdose/Unconscious ‚â• C
  if ((subtype==='Overdose / Poisoning' || subtype==='Unconscious / Fainting') && ['C','D','E'].includes(prio)){
    ensureStation(); // tone station
    log(`STA-${$('#station').value} NARCAN ASSIST ALERT`);
    CURRENT.flags.narcan = true;
  }
  // MVA/Rescue rules: tone station + EMS, RSU for HV/Entrap/Pin-in/Rollover, set Veh Acc w/ Rescue code
  if ($('#category').value==='RESCUE'){
    ensureStation();
    ensureEMSBase();
    if (['MVC ‚Äî High Velocity','MVC ‚Äî Entrapment','MVC ‚Äî Pin-in','MVC ‚Äî Rollover'].includes(subtype)){
      CURRENT.flags.rescue=true;
      CURRENT.units.add('RSU');
      CURRENT.codeOverride = '32-D-01'; // Veh Acc w/ Rescue
      $('#determinant').value = `32-D-01`;
      $('#prio').value='D';
      log(`RSU auto-added for ${subtype}`);
    }
  }
  // EMS Echo: add Station Assist
  if ($('#category').value==='EMS' && prio==='E'){
    ensureStation(); CURRENT.flags.echoAssist=true;
  }
}
function ensureStation(){
  const st = $('#station').value;
  const tag = `STATION-${st}`;
  CURRENT.units.add(tag);
  CURRENT.flags.station = true;
}
function ensureEMSBase(){
  // default EMS recommendation: M101 (ALS) if free, else M102
  CURRENT.units.add('M101');
}

/* ============ Units Board ============ */
function loadUnits(){
  UNITS = JSON.parse(localStorage.getItem('rbUnits')||'{}');
  if(!Object.keys(UNITS).length){
    for(const u of UNIT_LIST){ UNITS[u.id] = {name:u.name,state:'AVAILABLE'}; }
    // Station placeholders (virtual "unit")
    UNITS['STATION-4'] = {name:'Station 4 RBVFD', state:'AVAILABLE'};
    // (Station 3 later) UNITS['STATION-3'] = {name:'Station 3 RBVFD', state:'AVAILABLE'};
    saveUnits();
  }
}
function saveUnits(){ localStorage.setItem('rbUnits', JSON.stringify(UNITS)); }
function renderUnits(){
  const pool = $('#unitPool'); pool.innerHTML='';
  Object.entries(UNITS).forEach(([id,u])=>{
    if(OOS_FILTER && u.state!=='OOS') return;
    const chip=document.createElement('div');
    chip.className='chip'; chip.dataset.id=id; chip.dataset.state=u.state;
    chip.innerHTML = `<strong>${id}</strong><em>${u.name}</em>`;
    chip.addEventListener('click', ()=>advanceUnit(id));
    pool.appendChild(chip);
  });
}
function advanceUnit(id){
  const cur = UNITS[id].state;
  const idx = STATUS_FLOW.indexOf(cur); 
  const next = STATUS_FLOW[(idx+1) % STATUS_FLOW.length];
  UNITS[id].state = next; saveUnits(); renderUnits();
  log(`${id} ‚Üí ${next}`);
  // If a Station placeholder and any real STA unit goes out, auto-clear station
  if(id.startsWith('STATION-')) return;
  const st = $('#station').value;
  const tag = `STATION-${st}`;
  if (CURRENT && CURRENT.units.has(tag) && ['DISPATCHED','ENROUTE'].includes(next)){
    CURRENT.units.delete(tag); log(`${STATION_LABELS[st]} placeholder cleared (apparatus responding)`);
  }
}

/* ============ Call lifecycle ============ */
function seed(){
  const n1=['Alex','Taylor','Jordan','Riley','Casey','Morgan','Avery','Quinn','Blake','Reese'][Math.floor(Math.random()*10)];
  const n2=['Miller','Johnson','Garcia','Brown','Davis','Lopez','Wilson','Anderson','Thomas','White'][Math.floor(Math.random()*10)];
  $('#caller').value = `${n1} ${n2}`;
  $('#phone').value = `(555) 4${Math.floor(10+Math.random()*90)}-${Math.floor(100+Math.random()*900)}${Math.floor(Math.random()*10)}${Math.floor(Math.random()*10)}`;
  if(!$('#location').value) $('#location').value = `${100+Math.floor(Math.random()*800)} Maple St`;
}
function startCall(){
  CURRENT = {
    cad: $('#cad').value || nextCAD(),
    opened: nowZ(),
    category: $('#category').value,
    subtype: $('#subtype').value,
    prio: $('#prio').value,
    determinant: $('#determinant').value,
    location: $('#location').value, cross: $('#cross').value, city: $('#city').value,
    caller: $('#caller').value, phone: $('#phone').value,
    station: $('#station').value,
    units: new Set(),
    flags: {narcan:false, rescue:false, echoAssist:false, station:false},
    discordId: null
  };
  // Initial dispatch behavior
  if (CURRENT.category==='FIRE' || CURRENT.category==='RESCUE' || CURRENT.category==='SERVICE'){
    ensureStation();
  } else if (CURRENT.category==='EMS') {
    // EMS A‚ÄìD = EMS only
    ensureEMSBase();
  }
  log(`${CURRENT.cad} OPENED by ${$('#dispName').textContent}`);
  $('#cad').value = CURRENT.cad;
  computeDeterminant(); // also applies special rules
  summarizeUnits();
}
function summarizeUnits(){
  const names=[...CURRENT.units].map(id=> UNITS[id]?.name || id);
  log(`UNITS: ${names.join(', ')||'(pending)'}`);
}
function clearAll(){
  if(!confirm('Clear screen?')) return;
  CURRENT=null; $('#cad').value=peekCAD();
  $('#log').textContent=''; $('#active').textContent='IDLE';
}

/* ============ Bridge (Discord + Roblox via Worker) ============ */
async function postToWorker(kind){
  if(!CURRENT){ alert('Create/dispatch a call first.'); return; }
  const url = $('#bridgeUrl').value.trim(); if(!url) return alert('Set Bridge URL.');
  const payload = {
    action: kind, // 'discord' or 'roblox'
    call: {
      cadNumber: CURRENT.cad,
      station: CURRENT.station,
      stationName: STATION_LABELS[CURRENT.station],
      category: CURRENT.category,
      subtype: CURRENT.subtype,
      priority: $('#prio').value,
      determinant: $('#determinant').value,
      location: $('#location').value,
      cross: $('#cross').value,
      city: $('#city').value,
      caller: $('#caller').value,
      phone: $('#phone').value,
      narrative: $('#narrative').value,
      units: [...CURRENT.units],
      flags: CURRENT.flags,
      openedZulu: CURRENT.opened,
      dispatcher: $('#dispName').textContent
    }
  };
  try{
    const r = await fetch(url+'/upsert', {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
    const j = await r.json();
    if(j.discordId) CURRENT.discordId = j.discordId;
    alert((kind==='discord'?'Discord':'Roblox')+' updated.');
  }catch(e){ alert('Worker error. Check URL.'); }
}

/* ============ Init ============ */
function tick(){ $('#clock').textContent = new Date().toUTCString().slice(17,25) + 'Z'; }
function setDisp(){ const n=prompt('Dispatcher name:', localStorage.getItem('rbDisp')||''); if(n){localStorage.setItem('rbDisp',n); $('#dispName').textContent=n;} }
function init(){
  $('#dispName').textContent = localStorage.getItem('rbDisp')||'Unknown';
  $('#cad').value = peekCAD()==='RB-INC-0000'?nextCAD():peekCAD();
  loadUnits(); renderUnits();
  $('#category').addEventListener('change', buildSubtype);
  $('#subtype').addEventListener('change', buildQuestions);
  $('#compute').addEventListener('click', computeDeterminant);
  $('#seed').addEventListener('click', seed);
  $('#dispatch').addEventListener('click', ()=>{ if(!CURRENT) startCall(); else computeDeterminant(); summarizeUnits(); });
  $('#clear').addEventListener('click', clearAll);
  $('#oosFilter').addEventListener('click', ()=>{ OOS_FILTER=true; renderUnits(); });
  $('#allFilter').addEventListener('click', ()=>{ OOS_FILTER=false; renderUnits(); });
  document.querySelector('header').addEventListener('dblclick', setDisp);
  $('#toDiscord').addEventListener('click', ()=>postToWorker('discord'));
  $('#toRoblox').addEventListener('click', ()=>postToWorker('roblox'));
  buildSubtype(); tick(); setInterval(tick,1000);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
