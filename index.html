<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Riverbend CAD / PROQA ‚Äî Stations 4 & 3 (RBVFD)</title>
<style>
  :root{
    --bg:#0e1014;--card:#141826;--mut:#9fb8c2;--ink:#e9f7ef;--line:#20263a;
    --A:#2ecc71;--B:#1abc9c;--C:#f1c40f;--D:#e67e22;--E:#e74c3c
  }
  *{box-sizing:border-box}body{margin:0;background:#0b0d12;color:var(--ink);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Arial}
  header{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(#121522,#0e1017)}
  h1{font-size:16px;margin:0} .sub{font-size:12px;color:var(--mut)}
  .status{margin-left:auto;display:flex;gap:8px;align-items:center}
  .pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0f1220;font-size:12px}
  .wrap{max-width:1280px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:320px 1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;box-shadow:0 6px 22px rgba(0,0,0,.35)}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#121522;font-size:13px;text-transform:uppercase;letter-spacing:.5px;color:#cfeee0}
  .pad{padding:12px}
  label{display:block;margin:8px 0 4px;color:var(--mut);font-size:12px}
  input,select,textarea,button{width:100%;padding:9px 10px;border:1px solid #2a3150;background:#0f1220;color:var(--ink);border-radius:8px;font:inherit}
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .btn{cursor:pointer;transition:.15s transform ease}.btn:hover{transform:translateY(-1px)}
  .btn.primary{background:#16261d;border-color:#2b7a4b}.btn.warn{background:#2a2412;border-color:#7d6a2f}.btn.danger{background:#2a1412;border-color:#7d2f2f}
  .list{max-height:72vh;overflow:auto}
  .call{border-bottom:1px solid #1f2440;padding:8px 10px;cursor:pointer}
  .call:hover{background:#101426}
  .code{font-weight:600}
  .bar{height:3px;background:#333}
  .bar.A{background:var(--A)}.bar.B{background:var(--B)}.bar.C{background:var(--C)}.bar.D{background:var(--D)}.bar.E{background:var(--E)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #2a2e47;border-radius:999px;background:#0f1220}
  .mut{color:#9fb8c2}.sep{height:1px;background:linear-gradient(90deg,transparent,#232840,transparent);margin:10px 0}
  .note{font-size:12px;color:#97a5bd}
</style>
</head>
<body>
<header>
  <div style="width:36px;height:36px;border:1px solid var(--line);border-radius:8px;background:linear-gradient(135deg,#1a1d2d,#10121c)"></div>
  <div>
    <h1>Riverbend CAD / PROQA ‚Äî Stations 4 & 3 (RBVFD)</h1>
    <div class="sub">Multi-call ‚Ä¢ Dropdown PROQA ‚Ä¢ Auto Code/Upgrades ‚Ä¢ Discord & Roblox Sync</div>
  </div>
  <div class="status">
    <div class="pill">Dispatcher: <span id="disp">Unknown</span></div>
    <div class="pill" id="clock">--:--:--Z</div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: ACTIVE CALL LIST -->
  <section class="card">
    <h3>Active Calls</h3>
    <div class="pad">
      <div class="row">
        <div style="grid-column:span 6"><button class="btn primary" id="newCall">New Call</button></div>
        <div style="grid-column:span 6;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="pushDiscord">Push Discord</button>
          <button class="btn" id="pushRoblox">Push Roblox</button>
        </div>
      </div>
      <div id="callList" class="list"></div>
    </div>
  </section>

  <!-- RIGHT: CALL DETAIL / EDITOR -->
  <section class="card">
    <h3 id="detailTitle">Call Details</h3>
    <div class="pad">
      <div class="row">
        <div style="grid-column:span 3">
          <label>CAD #</label>
          <input id="cad" readonly />
        </div>
        <div style="grid-column:span 3">
          <label>Station</label>
          <select id="station">
            <option value="4">Station 4 RBVFD</option>
            <option value="3" disabled>Station 3 RBVFD (later)</option>
          </select>
        </div>
        <div style="grid-column:span 3">
          <label>Category</label>
          <select id="category">
            <option value="FIRE">üî• Fire</option>
            <option value="EMS">üöë EMS</option>
            <option value="RESCUE">üöí Rescue / MVA</option>
            <option value="SERVICE">‚öôÔ∏è Service</option>
          </select>
        </div>
        <div style="grid-column:span 3">
          <label>Subtype</label>
          <select id="subtype"></select>
        </div>
      </div>

      <div class="row">
        <div style="grid-column:span 4">
          <label>Priority</label>
          <select id="prio">
            <option value="A">Alpha</option><option value="B">Bravo</option>
            <option value="C">Charlie</option><option value="D">Delta</option><option value="E">Echo</option>
          </select>
        </div>
        <div style="grid-column:span 4">
          <label>Determinant</label>
          <input id="det" readonly placeholder="NN-X-YY"/>
        </div>
        <div style="grid-column:span 4">
          <label>Status</label>
          <select id="status">
            <option>Active</option><option>Holding</option><option>Cleared</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="grid-column:span 6">
          <label>Location</label>
          <input id="loc" placeholder="215 Maple St"/>
        </div>
        <div style="grid-column:span 3">
          <label>Cross</label>
          <input id="cross" placeholder="@ Oak Ave"/>
        </div>
        <div style="grid-column:span 3">
          <label>City</label>
          <input id="city" value="Riverbend County"/>
        </div>
      </div>

      <div class="row">
        <div style="grid-column:span 4">
          <label>Caller</label>
          <input id="caller" placeholder="Name"/>
        </div>
        <div style="grid-column:span 4">
          <label>Callback</label>
          <input id="phone" placeholder="(555) 555-0155"/>
        </div>
        <div style="grid-column:span 4">
          <label>Apparatus (dropdown)</label>
          <select id="apparatus">
            <option value="">‚Äî Select Unit ‚Äî</option>
            <option>E4-1</option><option>T4</option><option>SQ4-2</option><option>T4-3</option><option>B4</option><option>QRV4</option><option>CAR4</option>
            <option>Station 4</option>
            <option>M101</option><option>M102</option><option>M103</option><option>M1</option><option>RSU</option>
          </select>
        </div>
      </div>

      <!-- PROQA: all dropdowns, live recode -->
      <div class="sep"></div>
      <div class="grid2" id="questionHost"></div>

      <div class="sep"></div>
      <label>Narrative</label>
      <textarea id="narr"></textarea>

      <div class="sep"></div>
      <div class="grid2">
        <div>
          <button class="btn" id="addUnit">Add Unit</button>
          <button class="btn" id="clrStation">Clear Station Placeholder</button>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn warn" id="save">Save / Sync</button>
          <button class="btn danger" id="close">Close Call</button>
        </div>
      </div>

      <div class="sep"></div>
      <label>Assigned Units</label>
      <div class="chips" id="unitChips"></div>

      <div class="sep"></div>
      <div class="note">
        Rules: Fire/Rescue/Service ‚Üí tone <b>Station</b> (apparatus chosen by RBVFD).  
        EMS E ‚Üí Station assist; Overdose/Unconscious ‚â• C ‚Üí <b>Narcan Assist</b>;  
        MVC (High-Velocity / Entrapment / Pin-in / Rollover) ‚Üí <b>Veh Acc w/ Rescue</b> + RSU.  
        When a Station apparatus goes Dispatched/En Route, the <i>Station placeholder auto-clears</i>.
      </div>
    </div>
  </section>
</div>

<script>
/* ========== basic config ========== */
const BRIDGE = ""; // <‚Äî paste your Worker origin here (e.g., https://rivebendhook.vicanator423.workers.dev)
const STATIONS = {"4":"Station 4 RBVFD","3":"Station 3 RBVFD"};
const SUBTYPES = {
  FIRE:['Alarm ‚Äì Fire','Structure Fire','Vehicle Fire','Brush / Wildland','Gas Leak / HazMat'],
  EMS:['Breathing Problems','Chest Pain','Cardiac Arrest','Overdose / Poisoning','Unconscious / Fainting','Seizure','Trauma','Stroke','Sick Person'],
  RESCUE:['MVC ‚Äî Injury','MVC ‚Äî High Velocity','MVC ‚Äî Entrapment','MVC ‚Äî Pin-in','MVC ‚Äî Rollover','Technical Rescue'],
  SERVICE:['Public Assist','Investigation','Utility Problem','Standby']
};
const PROQA = {
  'Alarm ‚Äì Fire':{
    proto:'67', qs:{
      'Smoke visible?':['No','Yes'],
      'Flames visible?':['No','Yes'],
      'Occupants inside?':['Unknown','No','Yes'],
      'Building type':['SFD','Apartment','Commercial']
    }, calc:(a)=> (a['Flames visible?']==='Yes'||a['Smoke visible?']==='Yes')?'D-02':'B-01'
  },
  'Structure Fire':{
    proto:'67', qs:{
      'Smoke visible?':['No','Light','Heavy'],
      'Flames visible?':['No','Room','Multiple'],
      'Occupants inside?':['Unknown','No','Yes']
    }, calc:(a)=> (a['Flames visible?']!=='No'||a['Occupants inside?']==='Yes')?'D-02':'C-01'
  },
  'Vehicle Fire':{proto:'68', qs:{'Engine compartment?':['Unknown','No','Yes']}, calc:()=> 'C-01'},
  'Brush / Wildland':{proto:'69', qs:{'Size estimate':['< 1 acre','~1 acre','> 1 acre']}, calc:(a)=> a['Size estimate']==='> 1 acre'?'D-02':'C-02'},
  'Gas Leak / HazMat':{proto:'70', qs:{'Odor present?':['No','Yes'],'Evacuation?':['No','Yes']}, calc:(a)=> (a['Evacuation?']==='Yes'?'D-01':'C-01')},

  'Overdose / Poisoning':{
    proto:'23', qs:{
      'Conscious?':['No','Yes'],
      'Breathing normally?':['No','Yes'],
      'Suspected opioid?':['Unknown','No','Yes'],
      'Naloxone given?':['No','Yes']
    }, calc:(a)=> a['Breathing normally?']==='No'?'E-01':(a['Conscious?']==='No'?'D-01':'C-01')},
  'Unconscious / Fainting':{
    proto:'31', qs:{'Responsive?':['No','Yes'],'Breathing normally?':['No','Yes']},
    calc:(a)=> (a['Responsive?']==='No'&&a['Breathing normally?']==='No')?'E-01':(a['Responsive?']==='No'?'D-01':'C-01')
  },
  'Cardiac Arrest':{proto:'09', qs:{'CPR started?':['No','Yes'],'AED available?':['No','Yes']}, calc:()=> 'E-02'},
  'Breathing Problems':{proto:'06', qs:{'Breathing normally?':['No','Yes']}, calc:(a)=> a['Breathing normally?']==='No'?'E-01':'C-02'},
  'Chest Pain':{proto:'10', qs:{'Diaphoretic?':['No','Yes']}, calc:()=> 'C-01'},
  'Seizure':{proto:'12', qs:{'Active now?':['No','Yes']}, calc:(a)=> a['Active now?']==='Yes'?'D-01':'C-01'},
  'Trauma':{proto:'30', qs:{'Major bleeding?':['No','Yes']}, calc:(a)=> a['Major bleeding?']==='Yes'?'D-01':'C-02'},
  'Stroke':{proto:'28', qs:{'FAST positive?':['No','Yes']}, calc:(a)=> a['FAST positive?']==='Yes'?'D-01':'C-01'},
  'Sick Person':{proto:'26', qs:{'Severe symptoms?':['No','Yes']}, calc:(a)=> a['Severe symptoms?']==='Yes'?'C-01':'A-01'},

  'MVC ‚Äî Injury':{
    proto:'32', qs:{
      'Entrapment?':['No','Yes'],'Rollover?':['No','Yes'],'Pin-in?':['No','Yes'],'High velocity?':['No','Yes']
    }, calc:(a)=> (['Yes','Yes','Yes','Yes'].some((v,i)=>Object.values(a)[i]==='Yes')?'D-01':'C-01')
  },
  'MVC ‚Äî High Velocity':{proto:'32', qs:{}, calc:()=> 'D-01'},
  'MVC ‚Äî Entrapment':{proto:'32', qs:{}, calc:()=> 'D-01'},
  'MVC ‚Äî Pin-in':{proto:'32', qs:{}, calc:()=> 'D-01'},
  'MVC ‚Äî Rollover':{proto:'32', qs:{}, calc:()=> 'D-01'},

  'Public Assist':{proto:'53', qs:{'Medical component?':['No','Yes']}, calc:(a)=> a['Medical component?']==='Yes'?'B-01':'A-01'},
  'Investigation':{proto:'52', qs:{}, calc:()=> 'A-01'},
  'Utility Problem':{proto:'54', qs:{'Active hazard?':['No','Yes']}, calc:(a)=> a['Active hazard?']==='Yes'?'C-01':'B-01'},
  'Standby':{proto:'56', qs:{}, calc:()=> 'A-01'}
};

const STATUS_FLOW = ['DISPATCHED','ENROUTE','ONSCENE','TRANSPORT','RETURNING','CLEAR'];
let ACTIVE = JSON.parse(localStorage.getItem('rb_active')||'[]'); // array of call objects
function saveActive(){ localStorage.setItem('rb_active', JSON.stringify(ACTIVE)); }

const $ = s=>document.querySelector(s);
const nowZ=()=>new Date().toISOString().replace('T',' ').replace(/\.\d+Z$/,'Z');
const pad=n=>String(n).padStart(4,'0');
const nextCAD=()=>{let n=+localStorage.getItem('rbCadSeq')||0; n++; localStorage.setItem('rbCadSeq',n); return `RB-INC-${pad(n)}`;}
const peekCAD=()=>`RB-INC-${pad(+localStorage.getItem('rbCadSeq')||0)}`;
function tick(){ $('#clock').textContent=new Date().toUTCString().slice(17,25)+'Z';}

/* ===== Call list UI ===== */
let selected = null;
function renderList(){
  const host=$('#callList'); host.innerHTML='';
  ACTIVE.filter(c=>c.status!=='Cleared').forEach(c=>{
    const div=document.createElement('div'); div.className='call';
    div.innerHTML = `<div class="code">${c.det} ‚Äî ${c.subtype}</div>
      <div class="mut">${c.cad} ‚Ä¢ ${STATIONS[c.station]} ‚Ä¢ ${c.location||''}</div>
      <div class="bar ${c.prio}"></div>`;
    div.onclick=()=>selectCall(c.cad);
    host.appendChild(div);
  });
}
function selectCall(cad){
  selected = ACTIVE.find(c=>c.cad===cad);
  if(!selected) return;
  $('#detailTitle').textContent = `Call Details ‚Äî ${cad}`;
  // fill fields
  $('#cad').value = selected.cad;
  $('#station').value = selected.station;
  $('#category').value = selected.category;
  buildSubtype();
  $('#subtype').value = selected.subtype;
  $('#prio').value = selected.prio;
  $('#det').value = selected.det;
  $('#status').value = selected.status||'Active';
  $('#loc').value = selected.location||'';
  $('#cross').value = selected.cross||'';
  $('#city').value = selected.city||'Riverbend County';
  $('#caller').value = selected.caller||'';
  $('#phone').value = selected.phone||'';
  $('#narr').value = selected.narrative||'';
  renderQuestions();
  // preload answers
  for(const [k,v] of Object.entries(selected.answers||{})){
    const el = document.querySelector(`[data-q="${k}"]`);
    if(el){ el.value = v; }
  }
  renderUnits();
}

/* ===== subtype + questions ===== */
function buildSubtype(){
  const cat=$('#category').value; const list=SUBTYPES[cat]||[];
  $('#subtype').innerHTML = list.map(s=>`<option>${s}</option>`).join('');
  renderQuestions();
}
function renderQuestions(){
  const st = $('#subtype').value;
  const spec = PROQA[st]; const host=$('#questionHost'); host.innerHTML='';
  if(!spec){ $('#det').value=''; return; }
  for(const [q,opts] of Object.entries(spec.qs)){
    const wrap=document.createElement('div');
    wrap.innerHTML = `<label>${q}</label><select data-q="${q}">${opts.map(o=>`<option>${o}</option>`).join('')}</select>`;
    host.appendChild(wrap);
  }
  // attach change listeners to recalc
  host.querySelectorAll('select').forEach(s=> s.onchange = autoCompute );
}
function answersFromUI(){
  const out={}; document.querySelectorAll('[data-q]').forEach(el=> out[el.dataset.q]=el.value );
  return out;
}

/* ===== auto compute & upgrade rules ===== */
function autoCompute(){
  if(!selected) return;
  selected.answers = answersFromUI();
  // compute determinant
  const st = $('#subtype').value; const spec = PROQA[st];
  if(spec){
    const tail = spec.calc(selected.answers); // e.g., 'D-02'
    const letter = tail.split('-')[0];
    selected.det = `${spec.proto}-${tail}`;
    selected.prio = letter;
    $('#det').value = selected.det; $('#prio').value = selected.prio;
  }
  // upgrades / special logic
  upgradeLogic();
  // narcan / echo assist station tone
  assistLogic();
  saveActive(); renderList();
}
function upgradeLogic(){
  const st = $('#subtype').value; const a = selected.answers||{};
  // Alarm ‚Üí Structure if smoke/flames
  if(st==='Alarm ‚Äì Fire' && (a['Smoke visible?']==='Yes' || a['Flames visible?']==='Yes')){
    $('#subtype').value = 'Structure Fire';
    selected.subtype = 'Structure Fire';
    const spec = PROQA['Structure Fire']; const tail= spec.calc(a); selected.det=`${spec.proto}-${tail}`; selected.prio=tail.split('-')[0];
    $('#det').value = selected.det; $('#prio').value=selected.prio;
  }
  // MVC base to Rescue if HV/Entrap/Pin-in/Rollover
  if(st==='MVC ‚Äî Injury'){
    const hit = ['Entrapment?','Rollover?','Pin-in?','High velocity?'].some(k=> (selected.answers[k]||'No')==='Yes' );
    if(hit){
      selected.subtype = 'MVC ‚Äî Entrapment';
      $('#subtype').value = 'MVC ‚Äî Entrapment';
      selected.det = `32-D-01`; selected.prio='D'; $('#det').value=selected.det; $('#prio').value='D';
      // ensure RSU present
      selected.units = new Set(selected.units||[]);
      selected.units.add('RSU');
    }
  }
}
function assistLogic(){
  const st = selected.subtype; const p = selected.prio;
  selected.flags = selected.flags||{};
  // Echo Assist (EMS E)
  if(selected.category==='EMS' && p==='E'){
    selected.flags.echoAssist = true;
    addStationPlaceholder(selected.station);
  }
  // Narcan Assist (Overdose/Unconscious >= C)
  if((st==='Overdose / Poisoning' || st==='Unconscious / Fainting') && ['C','D','E'].includes(p)){
    selected.flags.narcan = true; addStationPlaceholder(selected.station);
  }
}
function addStationPlaceholder(n){ if(!selected.units) selected.units = new Set(); selected.units.add(`Station ${n}`); }

/* ===== units ===== */
function renderUnits(){
  const host=$('#unitChips'); host.innerHTML='';
  const arr = Array.from(selected.units||[]);
  arr.forEach(id=>{
    const chip=document.createElement('div'); chip.className='chip';
    chip.innerHTML = `<strong>${id}</strong>
      <select data-unit="${id}">
        ${STATUS_FLOW.map(s=>`<option>${s}</option>`).join('')}
      </select>`;
    host.appendChild(chip);
  });
  host.querySelectorAll('select').forEach(s=>{
    s.onchange = (e)=>{
      const id=e.target.dataset.unit; const st=e.target.value;
      // when any Station apparatus goes EnRoute/Dispatched, clear station placeholder
      if(!id.startsWith('Station') && (st==='DISPATCHED'||st==='ENROUTE')){
        const tag = `Station ${selected.station}`;
        if((selected.units||new Set()).has(tag)){
          selected.units.delete(tag);
        }
      }
      // auto sync after change
      saveActive(); push('discord'); push('roblox');
    }
  });
}

/* ===== buttons ===== */
$('#newCall').onclick = ()=>{
  const cad = nextCAD();
  const call = {
    cad, station:'4', category:'FIRE', subtype:'Alarm ‚Äì Fire', prio:'B', det:'67-B-01',
    status:'Active', opened: nowZ(), location:'', cross:'', city:'Riverbend County',
    caller:'', phone:'', narrative:'', answers:{}, units:new Set(['Station 4']), flags:{}, discordId:null
  };
  ACTIVE.unshift(call); saveActive(); renderList(); selectCall(cad);
};
$('#save').onclick = ()=>{
  if(!selected) return;
  // persist fields
  selected.station = $('#station').value; selected.category=$('#category').value; selected.subtype=$('#subtype').value;
  selected.prio=$('#prio').value; selected.det=$('#det').value; selected.status=$('#status').value;
  selected.location=$('#loc').value; selected.cross=$('#cross').value; selected.city=$('#city').value;
  selected.caller=$('#caller').value; selected.phone=$('#phone').value; selected.narrative=$('#narr').value;
  saveActive(); renderList(); push('discord'); push('roblox');
  alert('Saved & synced.');
};
$('#close').onclick = ()=>{
  if(!selected) return;
  selected.status='Cleared'; saveActive(); renderList(); push('discord'); push('roblox');
  alert('Call cleared & synced.'); selectCall(selected.cad);
};
$('#addUnit').onclick = ()=>{
  if(!selected) return;
  const u = $('#apparatus').value.trim(); if(!u) return;
  selected.units = new Set(selected.units||[]); selected.units.add(u);
  saveActive(); renderUnits(); push('discord'); push('roblox');
};
$('#clrStation').onclick = ()=>{
  if(!selected) return;
  const tag=`Station ${selected.station}`;
  if((selected.units||new Set()).has(tag)){ selected.units.delete(tag); saveActive(); renderUnits(); push('discord'); push('roblox'); }
};
$('#pushDiscord').onclick = ()=> push('discord');
$('#pushRoblox').onclick = ()=> push('roblox');
document.querySelector('header').ondblclick = ()=>{
  const name = prompt('Dispatcher name:', localStorage.getItem('rbDisp')||'');
  if(name){ localStorage.setItem('rbDisp',name); $('#disp').textContent=name; }
};

/* ===== live compute hooks ===== */
$('#category').onchange = ()=>{ buildSubtype(); autoCompute(); };
$('#subtype').onchange = ()=>{ renderQuestions(); autoCompute(); };

/* ===== bridge ===== */
async function push(kind){
  if(!selected){ alert('Select a call first'); return; }
  if(!BRIDGE){ alert('Set BRIDGE URL at top of file.'); return; }
  const payload = {
    action: kind, call: serializable(selected)
  };
  try{
    const r = await fetch(BRIDGE+'/upsert',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
    await r.json();
  }catch(e){ console.warn('Bridge error', e); }
}
function serializable(c){
  return {
    cadNumber:c.cad, station:c.station, stationName:STATIONS[c.station],
    category:c.category, subtype:c.subtype, priority:c.prio, determinant:c.det,
    status:c.status, openedZulu:c.opened,
    location:c.location, cross:c.cross, city:c.city,
    caller:c.caller, phone:c.phone, narrative:c.narrative,
    answers:c.answers, units:Array.from(c.units||[]), flags:c.flags,
    dispatcher: (localStorage.getItem('rbDisp')||'Unknown')
  };
}

/* ===== init ===== */
function init(){
  $('#disp').textContent = localStorage.getItem('rbDisp')||'Unknown';
  if(!ACTIVE.length){ // seed list with last CAD for UI continuity
    $('#cad').value = peekCAD()==='RB-INC-0000'?nextCAD():peekCAD();
  }
  buildSubtype(); renderList(); tick(); setInterval(tick,1000);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
